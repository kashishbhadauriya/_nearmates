<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat with <%= friend.name %></title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    /* your previous CSS kept same, only new buttons added */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .chat-container {
      width: 100%;
      max-width: 800px;
      height: 90vh;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .avatar {
      width: 45px; height: 45px;
      border-radius: 50%;
      background: white; color: #667eea;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; font-size: 18px;
    }

    #chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 25px;
      background: #f8f9fa;
    }

    .message-wrapper { margin-bottom: 20px; display: flex; flex-direction: column; }
    .mine { align-items: flex-end; }
    .theirs { align-items: flex-start; }

    .message {
      max-width: 65%;
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
    }
    .mine .message {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .theirs .message {
      background: white;
      color: #2d3748;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .message img {
      max-width: 200px;
      border-radius: 10px;
      display: block;
    }
    audio {
      outline: none;
      width: 200px;
      margin-top: 5px;
    }

    .timestamp { font-size: 11px; color: #a0aec0; margin-top: 5px; }

    .input-area {
      padding: 15px 20px;
      border-top: 1px solid #e2e8f0;
      background: white;
    }
    .input-container {
      display: flex; gap: 10px; align-items: center;
    }

    #messageInput {
      flex: 1;
      padding: 14px 18px;
      border: 2px solid #e2e8f0;
      border-radius: 25px;
      font-size: 15px;
      outline: none;
    }

    .icon-btn, .send-btn {
      width: 45px; height: 45px;
      border: none; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: 0.3s;
    }

    .icon-btn { background: #edf2f7; color: #4a5568; }
    .icon-btn:hover { background: #e2e8f0; }
    .send-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <div class="avatar"><%= friend.name.charAt(0).toUpperCase() %></div>
      <div>
        <h2><%= friend.name %></h2>
        <p>Active now</p>
      </div>
    </div>

    <div id="chat-box">
      <% messages.forEach(msg => { %>
        <div class="message-wrapper <%= msg.sender.toString() === user._id.toString() ? 'mine' : 'theirs' %>">
          <div class="message">
            <% if (msg.type === 'image') { %>
              <img src="<%= msg.message %>" />
            <% } else if (msg.type === 'audio') { %>
              <audio controls src="<%= msg.message %>"></audio>
            <% } else if (msg.type === 'location') { %>
              <a href="<%= msg.message %>" target="_blank">üìç Shared Location</a>
            <% } else { %>
              <%= msg.message %>
            <% } %>
          </div>
          <span class="timestamp"><%= new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) %></span>
        </div>
      <% }) %>
    </div>

    <div class="input-area">
      <form id="message-form">
        <div class="input-container">
          <button type="button" class="icon-btn" id="imageBtn">üñºÔ∏è</button>
          <input type="file" id="imageInput" accept="image/*" style="display:none;" />
          <button type="button" class="icon-btn" id="locationBtn">üìç</button>
         
          <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off" />
          <button type="submit" class="send-btn">‚û§</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const socket = io();
    const userId = "<%= user._id %>";
    const receiverId = "<%= friend._id %>";

    const chatBox = document.getElementById("chat-box");
    const form = document.getElementById("message-form");
    const input = document.getElementById("messageInput");
    const imageBtn = document.getElementById("imageBtn");
    const imageInput = document.getElementById("imageInput");
    const locationBtn = document.getElementById("locationBtn");
    const voiceBtn = document.getElementById("voiceBtn");

    chatBox.scrollTop = chatBox.scrollHeight;
    socket.emit("user-connected", userId);

    form.addEventListener("submit", e => {
      e.preventDefault();
      const message = input.value.trim();
      if (!message) return;
      sendMessage(message, "text");
      input.value = "";
    });

    // IMAGE SEND
    imageBtn.addEventListener("click", () => imageInput.click());
    imageInput.addEventListener("change", () => {
      const file = imageInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => sendMessage(reader.result, "image");
      reader.readAsDataURL(file);
    });

    // LOCATION
    locationBtn.addEventListener("click", () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          const { latitude, longitude } = pos.coords;
          const link = `https://maps.google.com/?q=${latitude},${longitude}`;
          sendMessage(link, "location");
        });
      } else alert("Geolocation not supported");
    });

    // VOICE NOTE
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;

    voiceBtn.addEventListener("click", async () => {
      if (!isRecording) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.start();
          isRecording = true;
          voiceBtn.textContent = "‚èπÔ∏è"; // stop icon

          mediaRecorder.addEventListener("dataavailable", (e) => audioChunks.push(e.data));
          mediaRecorder.addEventListener("stop", () => {
            const blob = new Blob(audioChunks, { type: "audio/ogg; codecs=opus" });
            const reader = new FileReader();
            reader.onloadend = () => sendMessage(reader.result, "audio");
            reader.readAsDataURL(blob);
            audioChunks = [];
            voiceBtn.textContent = "üé§";
            isRecording = false;
          });
        } catch (err) {
          alert("Mic access denied");
        }
      } else {
        mediaRecorder.stop();
      }
    });

    // RECEIVE MESSAGE
    socket.on("private-message", (msg) => {
      if (
        (msg.senderId === userId && msg.receiverId === receiverId) ||
        (msg.senderId === receiverId && msg.receiverId === userId)
      ) addMessage(msg);
    });

    function sendMessage(message, type) {
      const msg = { senderId: userId, receiverId, message, type, timestamp: new Date() };
      socket.emit("send-private-message", msg);
      addMessage(msg);
    }

    function addMessage(msg) {
      const wrap = document.createElement("div");
      wrap.classList.add("message-wrapper", msg.senderId === userId ? "mine" : "theirs");

      const div = document.createElement("div");
      div.classList.add("message");

      if (msg.type === "image") {
        const img = document.createElement("img");
        img.src = msg.message;
        div.appendChild(img);
      } else if (msg.type === "audio") {
        const audio = document.createElement("audio");
        audio.controls = true;
        audio.src = msg.message;
        div.appendChild(audio);
      } else if (msg.type === "location") {
        const a = document.createElement("a");
        a.href = msg.message;
        a.textContent = "üìç Shared Location";
        a.target = "_blank";
        div.appendChild(a);
      } else {
        div.textContent = msg.message;
      }

      const time = document.createElement("span");
      time.classList.add("timestamp");
      time.textContent = new Date(msg.timestamp).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

      wrap.appendChild(div);
      wrap.appendChild(time);
      chatBox.appendChild(wrap);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  </script>
</body>
</html>

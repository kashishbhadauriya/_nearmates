<!DOCTYPE html>
<html>
<head>
  <title>User Locations</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Inter',sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;
      display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      padding:20px;overflow-x:hidden;
    }
    body::before {
      content:'';position:fixed;top:0;left:0;width:100%;height:100%;
      background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="60" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="90" cy="80" r="2.5" fill="rgba(255,255,255,0.1)"/><circle cx="10" cy="90" r="1.5" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
      animation:float 20s linear infinite;pointer-events:none;z-index:1;
    }
    @keyframes float {0%{transform:translateY(0) rotate(0);}100%{transform:translateY(-100vh) rotate(360deg);}}

    .container {
      background:rgba(255,255,255,0.1);
      backdrop-filter:blur(20px);
      border-radius:25px;
      padding:30px;
      box-shadow:0 20px 40px rgba(0,0,0,0.1),0 0 0 1px rgba(255,255,255,0.2);
      width:95%;max-width:1200px;z-index:2;
    }

    h2 {
      font-weight:700;color:white;font-size:2.5em;margin-bottom:10px;
      text-shadow:0 4px 8px rgba(0,0,0,0.2);
      display:flex;align-items:center;justify-content:center;gap:15px;
      letter-spacing:-0.02em;
    }
    .location-icon{font-size:1.2em;animation:pulse 2s ease-in-out infinite;}
    @keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.1);}}

    /* Distance slider */
    .distance-control {
      text-align:center;margin-bottom:20px;color:white;
      font-weight:500;font-size:15px;
    }
    .distance-control input[type=range] {
      width:200px;margin-left:10px;vertical-align:middle;
    }
    #map {
      height:75vh;width:100%;
      border-radius:20px;
      box-shadow:0 15px 35px rgba(0,0,0,0.15),inset 0 0 0 1px rgba(255,255,255,0.1);
      overflow:hidden;
    }

    .chat-btn {
      display:inline-block;margin-top:12px;padding:10px 20px;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:white;border-radius:25px;font-size:13px;font-weight:600;
      text-decoration:none;transition:all .3s ease;
    }
    .chat-btn:hover {transform:translateY(-2px);background:linear-gradient(135deg,#5a67d8 0%,#6b46c1 100%);}
    .loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:white;display:flex;align-items:center;gap:10px;}
    .spinner{width:20px;height:20px;border:2px solid rgba(255,255,255,0.3);border-top:2px solid white;border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{0%{transform:rotate(0);}100%{transform:rotate(360deg);}}

    .back-button-container{position:fixed;top:20px;left:20px;z-index:10;}
    .btn-chat{padding:10px 20px;background:linear-gradient(135deg,#ff0096 0%,#7f00ff 100%);color:white;border:none;border-radius:12px;cursor:pointer;font-weight:600;}
  </style>
</head>
<body>
  <div class="container">
    <div class="back-button-container">
      <button type="button" class="btn-chat" onclick="window.history.back()">Back</button>
    </div>

    <h2><span class="location-icon">üìç</span>Nearby Users</h2>

    <!-- üß≠ Distance selector -->
    <div class="distance-control">
      Show users within:
      <input type="range" id="distanceRange" min="1" max="1000" value="100" oninput="updateDistanceLabel(this.value)">
      <span id="distanceLabel">100 km</span>
      <button onclick="reloadMarkers()" class="btn-chat" style="margin-left:15px;">üîÑ Refresh</button>
    </div>

    <div id="map">
      <div class="loading">
        <div class="spinner"></div> Loading your location...
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    let map, markers, myLat, myLng, selectedDistance = 100;
    const defaultIcon = '/uploads/icon.png';

    function updateDistanceLabel(val) {
      selectedDistance = parseInt(val);
      document.getElementById('distanceLabel').textContent = `${selectedDistance} km`;
    }

    function removeLoading() {
      const loading = document.querySelector('.loading');
      if (loading) loading.remove();
    }

    map = L.map('map').setView([20.5937, 78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors', maxZoom: 19
    }).addTo(map);
    markers = L.markerClusterGroup();

    function getDistanceFromLatLon(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 +
                Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
                Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function loadNearbyUsers() {
      if (!myLat || !myLng) return;
      markers.clearLayers();

      fetch("/api/locations")
        .then(res => res.json())
        .then(users => {
          let nearbyFound = false;
          users.forEach(user => {
            if (!user.location) return;
            const { latitude, longitude } = user.location;
            const dist = getDistanceFromLatLon(myLat, myLng, latitude, longitude);
            if (dist <= selectedDistance) {
              nearbyFound = true;
              const dp = user.dp || defaultIcon;
              const userIcon = L.divIcon({
                className: 'user-icon',
                html: `<img src="${dp}" alt="${user.name}" style="width:40px;height:40px;border-radius:50%;border:2px solid #667eea;object-fit:cover;">`,
                iconSize:[40,40],iconAnchor:[20,40]
              });
              const popupHTML = `
                <b>${user.name}</b>
                <div style="margin:8px 0;color:#666;font-size:13px;">
                  üèÄ <strong>Sport:</strong> ${user.interests || "Not specified"}<br>
                  üìç <strong>Distance:</strong> ${dist.toFixed(2)} km
                </div>
                <a href="/chat/${user._id}" class="chat-btn">üí¨ Start Chat</a>
              `;
              L.marker([latitude, longitude], { icon:userIcon }).bindPopup(popupHTML).addTo(markers);
            }
          });
          map.addLayer(markers);
          if (!nearbyFound) window.location.href = "/alluser"; // redirect if none
        })
        .catch(err => console.error("Failed to fetch:", err));
    }

    function reloadMarkers() {
      loadNearbyUsers();
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        removeLoading();
        myLat = pos.coords.latitude;
        myLng = pos.coords.longitude;

        const currentUserIcon = L.divIcon({
          html:`<img src="/uploads/locationicon.png" alt="You" style="width:45px;height:45px;border-radius:50%;border:3px solid #ff4757;">`,
          iconSize:[45,45],iconAnchor:[22,45]
        });
        L.marker([myLat, myLng], {icon:currentUserIcon}).addTo(map).bindPopup("<b>You are here</b>").openPopup();
        map.setView([myLat, myLng], 13);

        fetch('/save-location', {
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({latitude:myLat,longitude:myLng})
        }).then(()=>loadNearbyUsers());
      }, ()=>{removeLoading();alert("Location access denied!");});
    } else { alert("Geolocation not supported."); }

    map.on('load', removeLoading);
  </script>
</body>
</html>
